___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "categories": [
    "REMARKETING",
    "ANALYTICS",
    "ADVERTISING",
    "ATTRIBUTION",
    "CONVERSIONS",
    "TAG_MANAGEMENT",
    "AFFILIATE_MARKETING"
  ],
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Alphalyr Marketing Studio",
  "brand": {
    "id": "github.com_Alphalyr",
    "displayName": "Alphalyr",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKQAAACVCAMAAADhTaF7AAAAM1BMVEWRWYu1kLHayNh1MG728fXIrMWjdZ5+Pnft4+zj1eKITIGaZ5XRus6tg6i+nrtsImT///8sTjt0AAAAEXRSTlP/////////////////////ACWtmWIAAAAJcEhZcwAACxMAAAsTAQCanBgAAAW4aVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA3LjEtYzAwMCA3OS5lZGEyYjNmYWMsIDIwMjEvMTEvMTctMTc6MjM6MTkgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIiB4bWxuczpwaG90b3Nob3A9Imh0dHA6Ly9ucy5hZG9iZS5jb20vcGhvdG9zaG9wLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCAyMy4xIChNYWNpbnRvc2gpIiB4bXA6Q3JlYXRlRGF0ZT0iMjAyMi0xMS0yMVQxMzo0ODowN1oiIHhtcDpNb2RpZnlEYXRlPSIyMDIyLTExLTIxVDEzOjUwOjE3WiIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMi0xMS0yMVQxMzo1MDoxN1oiIGRjOmZvcm1hdD0iaW1hZ2UvcG5nIiBwaG90b3Nob3A6Q29sb3JNb2RlPSIyIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjI0YzE2ZDc0LWQyZDctNDdlNy1iYWZmLWEyZmNhYzNmNzkyYSIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOmFiY2Y5NDI2LWI3MTItOTI0NC1hNTExLTM2YThmMzg3MDZiOCIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjBmNGYyZWY4LWZhNDUtNDlhYi04NjhhLThlYzBkZWViZDE3NyI+IDx4bXBNTTpIaXN0b3J5PiA8cmRmOlNlcT4gPHJkZjpsaSBzdEV2dDphY3Rpb249ImNyZWF0ZWQiIHN0RXZ0Omluc3RhbmNlSUQ9InhtcC5paWQ6MGY0ZjJlZjgtZmE0NS00OWFiLTg2OGEtOGVjMGRlZWJkMTc3IiBzdEV2dDp3aGVuPSIyMDIyLTExLTIxVDEzOjQ4OjA3WiIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDIzLjEgKE1hY2ludG9zaCkiLz4gPHJkZjpsaSBzdEV2dDphY3Rpb249InNhdmVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjI0YzE2ZDc0LWQyZDctNDdlNy1iYWZmLWEyZmNhYzNmNzkyYSIgc3RFdnQ6d2hlbj0iMjAyMi0xMS0yMVQxMzo1MDoxN1oiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkFkb2JlIFBob3Rvc2hvcCAyMy4xIChNYWNpbnRvc2gpIiBzdEV2dDpjaGFuZ2VkPSIvIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/Pt+akxIAAAZ4SURBVHja7ZzZlqwqDIbDICIq8P5Puy+qz+5SGfIDWrXXOrntLv0MmQgDxX9AaOTD5Jt8HaSVwtAcTjKTEdJ+BaQUpEJB1CrkRyGtXwNLVm8/A2m9C4C4Ds5WyIkCLDQ9CWl3FZpECfsQpDWhQ4x9ALIPsQ2TnkYMIQSj74QUKgwRJW6DlHMYJrO8BVKbMFR2PR5ypBpRZXIh93CDiKGQ1oVbhPQ4SKnCTaKWUZBT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\u003d"
  },
  "description": "Implementation of tracking code for Alphalyr Marketing Studio\n@author Yoan Yahemdi\n@web https://alphalyr.com\n@version 2022-11-21",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "SELECT",
    "name": "trackType",
    "displayName": "Tracking type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "home",
        "displayValue": "Home page"
      },
      {
        "value": "category",
        "displayValue": "Category page"
      },
      {
        "value": "product",
        "displayValue": "Product page"
      },
      {
        "value": "cart",
        "displayValue": "Cart page"
      },
      {
        "value": "addToCart",
        "displayValue": "Add to cart"
      },
      {
        "value": "confirmation",
        "displayValue": "Transaction page"
      },
      {
        "value": "consentping",
        "displayValue": "Consent ping"
      },
      {
        "value": "lead",
        "displayValue": "Lead confirmation page"
      },
      {
        "value": "other",
        "displayValue": "Other page"
      }
    ],
    "simpleValueType": true,
    "help": "Your track type method."
  },
  {
    "type": "GROUP",
    "name": "InitOptions",
    "displayName": "Init Options",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "customerId",
        "displayName": "Client public key",
        "simpleValueType": true,
        "help": "Unique public key given to you by Alphalyr Marketing Studio.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "alwaysInSummary": true
      },
      {
        "type": "TEXT",
        "name": "userEmail",
        "displayName": "User Email Hash",
        "simpleValueType": true,
        "help": "Hash MD5 de l’adresse email du client lorsqu’il est identifié. Laisser le paramètre vide si le\nclient n’est pas identifié."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "EventOptions",
    "displayName": "Product event details",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "productId",
        "displayName": "Product ID | Unique product identifier",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "product",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Match to \"prodId\" in technical documentation."
      },
      {
        "type": "TEXT",
        "name": "productDescription",
        "displayName": "Product Description",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "product",
            "type": "EQUALS"
          }
        ],
        "help": "Match to \"prodDescription\" in technical documentation."
      },
      {
        "type": "TEXT",
        "name": "productPrice",
        "displayName": "Product Price | Unit price excluding tax of the product",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "product",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "help": "Match to \"prodPrice\" in technical documentation."
      },
      {
        "type": "TEXT",
        "name": "categoryId",
        "displayName": "Category ID",
        "simpleValueType": true,
        "help": "Match to \"catId\" in technical documentation. Unique identifier of the product category.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "category",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "categoryDescription",
        "displayName": "Category Description",
        "simpleValueType": true,
        "help": "Match to \"catDescription\" in technical documentation. Description of the current category.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "category",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "basketTotalPrice",
        "displayName": "Total Price",
        "simpleValueType": true,
        "help": "Match to \"totalPrice\" in technical documentation.Total price of the basket excluding tax and excluding shipping price.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "cart",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "addTotalPrice",
        "displayName": "Total Price",
        "simpleValueType": true,
        "help": "Total price of the product added to basket excluding tax and excluding delivery.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "addToCart",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "transactionId",
        "displayName": "Transaction ID",
        "simpleValueType": true,
        "help": "Match to \"reference\" in technical documentation.\nUnique order reference.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "leadTransactionId",
        "displayName": "Lead Reference ID",
        "simpleValueType": true,
        "help": "Match to \"reference\" in technical documentation.\nUnique lead reference.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "lead",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "currency",
        "displayName": "Currency",
        "simpleValueType": true,
        "help": "Refers to the ISO-4217 code of the currency (example: EUR).",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "cart",
            "type": "EQUALS"
          },
          {
            "paramName": "trackType",
            "paramValue": "addToCart",
            "type": "EQUALS"
          },
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ],
        "valueHint": "EUR",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "productTable",
        "displayName": "Products Array with ID, QUANTITY, PRICE",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "cart",
            "type": "EQUALS"
          },
          {
            "paramName": "trackType",
            "paramValue": "addToCart",
            "type": "EQUALS"
          },
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ],
        "help": "This value must be filled in as follows: \n\nPRODUCTID1:PRODUCTQUANTITY1:PRODUCTUNITPRICE1; PRODUCTID2:PRODUCTQUANTITY2:PRODUCTUNITPRICE2 \n\nNote that the delimiters used are the characters \":\" for the different fields of a single product type and \" ; \" to delimit several types of products.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "valueHint": "PRODUCT_ID_1:PRODUCT_QUANTITY_1:PRODUCT_UNIT_PRICE_1; PRODUCT_ID_2:PRODUCT_QUANTITY_2:PRODUCT_UNIT_PRICE_2"
      },
      {
        "type": "TEXT",
        "name": "confirmationTotalPricewithout",
        "displayName": "Total Price | Excluding tax and delivery",
        "simpleValueType": true,
        "help": "Match to \"totalPrice\" in technical documentation.\nTotal price of the purchase excluding tax and excluding delivery.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "confirmationTotalPricewith",
        "displayName": "Total Price | Including tax and excluding delivery",
        "simpleValueType": true,
        "help": "Match to \"totalPriceWithTax\" in technical documentation.\nTotal price of the purchase including tax but excluding delivery.",
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "confirmationCustomerType",
        "displayName": "Customer Type",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ],
        "help": "Match to \"new\" in technical documentation.\nTakes the value \"0\" when it is an old client and \"1\" when it is a new client."
      },
      {
        "type": "TEXT",
        "name": "confirmationDiscountCode",
        "displayName": "Discount Code",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ],
        "help": "Match to \"discountCode\" in technical documentation.\nRefers to the discount code applied to the order."
      },
      {
        "type": "TEXT",
        "name": "confirmationDiscountAmount",
        "displayName": "Discount Amount",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ],
        "help": "Match to \"discountAmount\" in technical documentation.\nRefers to the total amount of the discount applied with the coupon code."
      },
      {
        "type": "GROUP",
        "name": "AdvancedTransactionOptions",
        "displayName": "Advanced Transaction Options",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "TEXT",
            "name": "confirmationShippingPrice",
            "displayName": "Total Shipping HT",
            "simpleValueType": true,
            "help": "Match to \"transactionshippingHT\" in technical documentation.\nTotal price of the delivery/shipping excluding tax.",
            "enablingConditions": []
          },
          {
            "type": "TEXT",
            "name": "confirmationOtherPrice",
            "displayName": "Total other price",
            "simpleValueType": true,
            "help": "Optional - Miscellaneous total price (e.g. the amount of the discount with promo code).",
            "enablingConditions": []
          },
          {
            "type": "TEXT",
            "name": "confirmationDeferMode",
            "displayName": "Defer mode",
            "simpleValueType": true,
            "help": "Optional - Set to \"0\" or \"1\". With the value \"1\", the order confirmation will work in deferred mode, the partner tags will not be called in real time, but after a validation from the tags will not be called in real time, but following a validation from the advertiser on the the advertiser, on the Alphalyr Marketing Studio user interface. This mode is generally used when payments are made by check. used when payments are made by check or bank transfer."
          },
          {
            "type": "PARAM_TABLE",
            "name": "confirmationCustomData",
            "displayName": "Custom Data",
            "paramTableColumns": [
              {
                "param": {
                  "type": "TEXT",
                  "name": "confirmationCustomDataKey",
                  "displayName": "Key",
                  "simpleValueType": true
                },
                "isUnique": false
              },
              {
                "param": {
                  "type": "TEXT",
                  "name": "confirmationCustomDataValue",
                  "displayName": "Value",
                  "simpleValueType": true
                },
                "isUnique": false
              }
            ],
            "help": "Optional - A key/value table to communicate additional data to the Alphalyr Marketing Studio solution.  Example : \u0026customData[meubles]\u003d150.55\u0026customData[hightech]\u003d1014.99"
          }
        ],
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "confirmation",
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "AdvancedCategoryOptions",
        "displayName": "Advanced Category Options",
        "groupStyle": "ZIPPY_CLOSED",
        "subParams": [
          {
            "type": "TEXT",
            "name": "categoryParentIds",
            "displayName": "Parent product IDs",
            "simpleValueType": true,
            "help": "Optional - List of unique identifiers of parent categories, separated by the \" , \".",
            "enablingConditions": []
          }
        ],
        "enablingConditions": [
          {
            "paramName": "trackType",
            "paramValue": "category",
            "type": "EQUALS"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "trackType",
        "paramValue": "home",
        "type": "NOT_EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "GDPRConfigurations",
    "displayName": "GDPR Consent options",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "TEXT",
        "name": "gdprConsent",
        "displayName": "GDPR Consent",
        "simpleValueType": true,
        "help": "consentPerformance"
      },
      {
        "type": "TEXT",
        "name": "consentAds",
        "displayName": "Consent statut for Ads \u0026 Marketing",
        "simpleValueType": true,
        "help": "Takes the value 1 if the user has consented to the use of his data for targeting and marketing. This parameter is transmitted to partners."
      },
      {
        "type": "TEXT",
        "name": "consentPerformance",
        "displayName": "Consent statut for Performance",
        "simpleValueType": true,
        "help": "Takes the value 1 if the user has consented to the use of his data for the measurement of performance measurement. This parameter is transmitted to partners."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const queryPermission = require('queryPermission');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const encodeUri = require('encodeUri');
const log = require('logToConsole');
const getUrl = require('getUrl');



const onSuccess = () => {
  data.gtmOnSuccess();
};

const onFailure = () => {
  data.gtmOnFailure();
};

const TEMPLATE_VERSION = '1.0.0';
const URL_PROTOCOL = getUrl('protocol');
const MARKETINGSTUDIO_LIBRARY_URL = 'https://tck.elitrack.com/';

let finalConstructor = '';


// -------- PATH CONSTRUCTOR --------
let track = data.trackType || '';
switch (track) {
    case 'consent':
      track = 'consent';
    break;

    case 'lead':
      track = 'lead';
    break;

    case 'confirmation':
      track = 'track';
    break;

    default:
      track = 'tag';
}

let pathConstructor = track;


// -------- GENERIC DATA --------
let page = data.trackType || '';
let aid = data.customerId || '';
let cid = data.userEmail || '';

let genericConstructor = '?page=' + page + '&aid=' + aid + '&cid=' + cid;
log('Generic Constructor OK');
let consentConstructor = '?aid=' + aid;
log('Consent Constructor OK');


// -------- PRODUCT PAGE DATA --------
let prodId = data.productId || '';
let prodDescription = data.productDescription || '';
let prodPrice = data.productPrice || '';
let catIds = data.categoryId || '';

let productPageConstructor = '&prodId=' + prodId + '&prodDescription=' + prodDescription + '&prodPrice=' + prodPrice + '&catIds=' + catIds;
log('Product Page Constructor OK');


// -------- PRODUCT ARRAY DATA --------
let products = data.productTable || '';
let currency = data.currency || '';
log('Product Array Constructor OK');


// -------- CATEGORY PAGE DATA --------
let catId = data.categoryId || '';
let catDescription = data.categoryDescription || '';
let parentIds = data.categoryParentIds || '';

let categoryPageConstructor = '&catId=' + catId + '&catDescription=' + catDescription + '&parentIds=' + parentIds;
log('Category Page Constructor OK');

// -------- CART PAGE DATA --------
let cartTotalPrice = data.basketTotalPrice || '';

let cartPageConstructor = '&products=' + products + '&totalPrice=' + cartTotalPrice + '&currency=' + currency;
log('CART Page Constructor OK');


// -------- ADD TO CART DATA --------
let addTotalPrice = data.addTotalPrice || '';

let cartAddConstructor = '&products=' + products + '&totalPrice=' + addTotalPrice + '&currency=' + currency;
log('AddToCart Constructor OK');

// -------- TRANSACTION DATA --------
let referenceTransaction = data.transactionId || '';
let transactionTotalPrice = data.confirmationTotalPricewithout || '';
let totalPriceWithTax = data.confirmationTotalPricewith || '';
let shippingPrice = data.confirmationShippingPrice || '';
let otherPrice = data.confirmationOtherPrice || '';
let clientType = data.confirmationCustomerType || '';
let discountCode = data.confirmationDiscountCode || '';
let discountAmount = data.confirmationDiscountAmount || '';
let defer = data.confirmationDeferMode || '';
let customDataKey = '';
let customDataValue = '';

let transactionPageConstructor = '&products=' + products + '&totalPrice=' + transactionTotalPrice + '&totalPriceWithTax=' + totalPriceWithTax + '&shippingPrice=' + shippingPrice + '&otherPrice=' + otherPrice + '&reference=' + referenceTransaction + '&new=' + clientType + '&currency=' + currency + '&discountCode=' + discountCode + '&discountAmount=' + discountAmount + '&defer=' + defer;
log('Transaction Page Constructor OK');

// -------- LEAD CONFIRMATION DATA --------
let leadreference = data.leadTransactionId || '';

let leadPageConstructor = '&reference=' + leadreference;
log('Lead Page Constructor OK');




// -------- GDPR Consent Constructor DATA --------
let gdpr_consent = data.gdprConsent ||'';
if (gdpr_consent == null || gdpr_consent == '' || gdpr_consent == undefined) {
  gdpr_consent = 0;
}
let consent_ads = data.consentAds || '';
if (consent_ads == null || consent_ads == '' ||  consent_ads == undefined) {
  consent_ads = 0;
}
let consent_performance = data.consentPerformance || '';
if (consent_performance == null || consent_performance == '' || consent_performance == undefined) {
  consent_performance = 0;
}
let gdprConstructor = '&gdpr_consent=' + gdpr_consent + '&consent_ads=' + consent_ads + '&consent_performance=' + consent_performance;
log('GDPR Page Constructor OK');

// -------- TRACKER CONSTRUCTOR --------
let tracker = data.trackType;
switch (tracker) {
    case 'home':
        finalConstructor = pathConstructor + genericConstructor + gdprConstructor;
    break;
  
    case 'category':
        finalConstructor = pathConstructor + genericConstructor + categoryPageConstructor + gdprConstructor;
    break;
  
    case 'product':
        finalConstructor = pathConstructor + genericConstructor + productPageConstructor + gdprConstructor;
    break;

    case 'cart':
        finalConstructor = pathConstructor + genericConstructor + cartPageConstructor + gdprConstructor;
    break;

    case 'AddToCart':
        finalConstructor = pathConstructor + genericConstructor + cartAddConstructor + gdprConstructor;
    break;

    case 'confirmation':
        finalConstructor = pathConstructor + genericConstructor + transactionPageConstructor + gdprConstructor;
    break;

    case 'consentping':
       finalConstructor = pathConstructor + consentConstructor + gdprConstructor;
    break;

    case 'lead':
        finalConstructor = pathConstructor + genericConstructor + leadPageConstructor + gdprConstructor;
    break;

    case 'other':
        finalConstructor = pathConstructor + genericConstructor + gdprConstructor;
    break;

    default: finalConstructor = pathConstructor + genericConstructor + gdprConstructor;

}
log('Tracker Constructor OK');

log(MARKETINGSTUDIO_LIBRARY_URL + finalConstructor);

let elitrackendpoint = encodeUri(MARKETINGSTUDIO_LIBRARY_URL + finalConstructor);

log(elitrackendpoint);
log('test');

if (queryPermission('inject_script', elitrackendpoint)) {
   injectScript(elitrackendpoint);
} else {
  data.gtmOnFailure();
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "any"
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://tck.elitrack.com/"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 21.11.2022 14:33:16